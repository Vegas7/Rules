name: Convert Tailscale DERP v6 to Mihomo

on:
  workflow_dispatch:
  workflow_run:
    workflows: ["Update Tailscale DERP IPv6"]
    types:
      - completed

permissions:
  contents: write

jobs:
  convert-to-mihomo:
    if: ${{ github.event.workflow_run.conclusion == 'success' }} || ${{ github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Convert Surge Rule to Mihomo CIDR
        run: |
          python <<EOF
          import os

          surge_file = 'Surge/tailscale_derp_v6.conf'
          mihomo_dir = 'Mihomo'
          mihomo_file = os.path.join(mihomo_dir, 'tailscale_derp_v6.txt')

          if not os.path.exists(surge_file):
              print(f"Error: {surge_file} not found!")
              exit(1)

          os.makedirs(mihomo_dir, exist_ok=True)

          print(f"Reading from {surge_file}...")
          
          mihomo_payload = []
          try:
              with open(surge_file, 'r') as f:
                  for line in f:
                      line = line.strip()
                      # 跳过空行和注释
                      if not line or line.startswith('#'):
                          continue
                      
                      # 解析 Surge 格式: IP-CIDR6,2607:xxxx/128,no-resolve
                      parts = line.split(',')
                      if len(parts) >= 2 and 'IP-CIDR' in parts[0]:
                          cidr = parts[1].strip()
                          # 生成标准 YAML 字符串列表项，使用单引号包裹以防解析错误
                          mihomo_payload.append(f"  - '{cidr}'")

              # 写入文件
              with open(mihomo_file, 'w') as f:
                  f.write("payload:\n")
                  f.write('\n'.join(mihomo_payload))
                  f.write('\n')

              print(f"Success! Converted {len(mihomo_payload)} CIDRs to {mihomo_file}")

          except Exception as e:
              print(f"Error during conversion: {e}")
              exit(1)
          EOF

      - name: Commit and Push changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add Mihomo/tailscale_derp_v6.txt
          git commit -m "Auto-convert to Mihomo IP-CIDR format" || echo "No changes to commit"
          git push