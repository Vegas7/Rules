name: Convert Tailscale DERP v6 to Mihomo

on:
  workflow_dispatch:
  workflow_run:
    workflows: ["Update Tailscale DERP IPv6"]
    types:
      - completed

permissions:
  contents: write

jobs:
  convert-to-mihomo:
    if: ${{ github.event.workflow_run.conclusion == 'success' }} || ${{ github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Convert Surge Rule to Plain Text
        run: |
          python <<EOF
          import os
          import datetime

          surge_file = 'Surge/tailscale_derp_v6.conf'
          mihomo_dir = 'Mihomo'
          mihomo_file = os.path.join(mihomo_dir, 'tailscale_derp_v6.txt')

          if not os.path.exists(surge_file):
              print(f"Error: {surge_file} not found!")
              exit(1)

          os.makedirs(mihomo_dir, exist_ok=True)

          print(f"Reading from {surge_file}...")
          
          lines_to_write = []
          # 添加文件头 (模仿你的截图格式)
          current_time = datetime.datetime.utcnow().strftime("%Y-%m-%d %H:%M:%S UTC")
          lines_to_write.append("# Tailscale DERP IPv6 List")
          lines_to_write.append(f"# Updated: {current_time}")
          
          try:
              with open(surge_file, 'r') as f:
                  for line in f:
                      line = line.strip()
                      # 跳过空行和原有注释
                      if not line or line.startswith('#'):
                          continue
                      
                      # 只要包含 IP-CIDR6 的行，直接保留原样
                      if 'IP-CIDR6' in line:
                          # 格式示例: IP-CIDR6,2607:xxxx/128,no-resolve
                          lines_to_write.append(line)

              # 写入纯文本文件 (不使用 YAML 格式)
              with open(mihomo_file, 'w') as f:
                  f.write('\n'.join(lines_to_write))
                  f.write('\n')

              print(f"Success! Written {len(lines_to_write)} lines to {mihomo_file}")

          except Exception as e:
              print(f"Error during conversion: {e}")
              exit(1)
          EOF

      - name: Commit and Push changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add Mihomo/tailscale_derp_v6.txt
          git commit -m "Update Mihomo Tailscale v6 list (Plain Text)" || echo "No changes to commit"
          git push