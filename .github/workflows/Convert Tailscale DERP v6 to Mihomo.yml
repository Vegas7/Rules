name: Convert Tailscale DERP v6 to Mihomo

on:
  workflow_dispatch:
  workflow_run:
    workflows: ["Update Tailscale DERP IPv6"]
    types:
      - completed

permissions:
  contents: write

jobs:
  convert-to-mihomo:
    if: ${{ github.event.workflow_run.conclusion == 'success' }} || ${{ github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Convert Surge Rule to Mihomo Rule
        run: |
          python <<EOF
          import os

          surge_file = 'Surge/tailscale_derp_v6.conf'
          mihomo_dir = 'Mihomo'
          mihomo_file = os.path.join(mihomo_dir, 'tailscale_derp_v6.txt')

          if not os.path.exists(surge_file):
              print(f"Error: {surge_file} not found!")
              exit(1)

          os.makedirs(mihomo_dir, exist_ok=True)

          print(f"Reading from {surge_file}...")
          
          mihomo_rules = []
          try:
              with open(surge_file, 'r') as f:
                  for line in f:
                      line = line.strip()
                      if not line or line.startswith('#'):
                          continue
                      
                      if 'IP-CIDR6' in line:
                          # 修改点：去掉了 line 外面的单引号
                          # 并且确保 IP-CIDR6 后面没有多余的空格干扰
                          mihomo_rules.append(f"  - {line}")

              with open(mihomo_file, 'w') as f:
                  f.write("payload:\n")
                  f.write('\n'.join(mihomo_rules))
                  f.write('\n')

              print(f"Success! Converted {len(mihomo_rules)} rules to {mihomo_file}")

          except Exception as e:
              print(f"Error during conversion: {e}")
              exit(1)
          EOF

      - name: Commit and Push changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add Mihomo/tailscale_derp_v6.txt
          git commit -m "Auto-convert Tailscale DERP v6 (Fix format)" || echo "No changes to commit"
          git push