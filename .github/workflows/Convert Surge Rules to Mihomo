name: Convert Surge Rules to Mihomo

on:
  push:
    paths:
      - 'Surge/*.conf'
    branches:
      - main
      - master
  workflow_dispatch:

permissions:
  contents: write

jobs:
  convert:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Create Conversion Script
        run: |
          cat << 'EOF' > convert_rules.py
          import os
          import re
          import glob

          # 配置目录
          SOURCE_DIR = 'Surge'
          TARGET_DIR = 'Mihomo'

          # 确保目标目录存在
          if not os.path.exists(TARGET_DIR):
              os.makedirs(TARGET_DIR)

          # 映射关系 (Surge -> Mihomo)
          # 注意：Mihomo 使用 DST-PORT 而不是 DEST-PORT
          TYPE_MAPPING = {
              'DEST-PORT': 'DST-PORT',
              'URL-REGEX': 'DOMAIN-REGEX'
          }

          def process_line(line):
              line = line.strip()
              # 跳过空行或纯注释行
              if not line or line.startswith(('#', '//', ';')):
                  return line
              
              # 暂时移除行内注释以便处理
              comment = ""
              if "//" in line:
                  parts = line.split("//", 1)
                  line = parts[0].strip()
                  comment = " //" + parts[1]
              
              # 处理逻辑规则 (AND, OR, NOT)
              # 逻辑规则通常包含括号，格式如: AND,((DEST-PORT,443),...),Proxy
              if line.upper().startswith(('AND', 'OR', 'NOT')):
                  # 找到最后一个逗号，这通常是分隔 规则 和 策略组 的地方
                  last_comma_index = line.rfind(',')
                  if last_comma_index != -1:
                      # 截取掉策略组部分
                      rule_part = line[:last_comma_index]
                      # 替换关键词 (如 DEST-PORT -> DST-PORT)
                      for s_key, m_key in TYPE_MAPPING.items():
                          rule_part = rule_part.replace(s_key, m_key)
                      return rule_part + comment
                  return line # 如果找不到逗号，可能本身就没有策略组，原样返回

              # 处理普通规则 (DOMAIN, IP-CIDR, etc.)
              # 格式: TYPE,VALUE,POLICY,OPTIONS(optional)
              parts = [p.strip() for p in line.split(',')]
              
              if len(parts) < 2:
                  return line + comment

              rule_type = parts[0].upper()
              
              # 映射类型名称
              if rule_type in TYPE_MAPPING:
                  parts[0] = TYPE_MAPPING[rule_type]

              # 处理 no-resolve
              is_no_resolve = 'no-resolve' in [p.lower() for p in parts]
              
              # 重组规则：保留 类型 和 值
              # Rule Set (Classical) 只需要: TYPE, VALUE [,no-resolve]
              new_line = f"{parts[0]},{parts[1]}"
              
              if is_no_resolve:
                  new_line += ",no-resolve"
                  
              return new_line + comment

          def convert_file(file_path):
              filename = os.path.basename(file_path)
              target_name = os.path.splitext(filename)[0] + '.txt'
              target_path = os.path.join(TARGET_DIR, target_name)
              
              print(f"Converting {filename} -> {target_name}...")
              
              with open(file_path, 'r', encoding='utf-8') as f:
                  lines = f.readlines()
              
              new_lines = []
              for line in lines:
                  # 简单的 [General] 或 [Rule] 标记跳过
                  if line.strip().startswith('[') and line.strip().endswith(']'):
                      continue
                  
                  try:
                      converted = process_line(line)
                      if converted:
                          new_lines.append(converted + '\n')
                  except Exception as e:
                      print(f"Error parsing line: {line.strip()} - {e}")
                      new_lines.append(f"# Error converting: {line}")

              with open(target_path, 'w', encoding='utf-8') as f:
                  f.writelines(new_lines)

          def main():
              files = glob.glob(os.path.join(SOURCE_DIR, '*.conf'))
              if not files:
                  print("No .conf files found in Surge directory.")
                  return

              for file in files:
                  convert_file(file)
              
              print("Conversion complete.")

          if __name__ == '__main__':
              main()
          EOF

      - name: Run Conversion Script
        run: python convert_rules.py

      - name: Commit and Push Changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add Mihomo/*.txt
          
          # 检查是否有变更，如果有则提交
          if git diff --staged --quiet; then
            print("No changes to commit.")
          else
            git commit -m "Auto-convert Surge rules to Mihomo ruleset [skip ci]"
            git push
          fi
